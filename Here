import asyncio
import logging
import random
import string
import io
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import BufferedInputFile

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
API_TOKEN = '8525811167:AAGkZVD46nu_0XbIJnGC-P3QKUZzYw8aMgU'

logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# --- –õ–û–ì–ò–ö–ê ULTRA VM –û–ë–§–£–°–ö–ê–¶–ò–ò (ONE-LINE EDITION) ---

class MelotenObfuscator:
    def __init__(self, source):
        self.source = source
        self.key = random.randint(100, 255)
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è "–Ω–µ–≤–∏–¥–∏–º—ã—Ö" –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        self.v_data = self._rand_name()
        self.v_key = self._rand_name()
        self.v_res = self._rand_name()
        self.v_check = self._rand_name()
        self.v_cur = self._rand_name()
        self.v_func = self._rand_name()

    def _rand_name(self):
        """–°–æ–∑–¥–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø–∞ lIlIIllI"""
        return "l" + "".join(random.choices("Il1", k=random.randint(10, 15)))

    def build(self):
        # 1. –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header = "--[[This file was protected with using Meloten Obfuscator\n\nhttp://t.me/Meloten_Obfuscator_bot]]\n"
        
        # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        encrypted_bytes = [(ord(char) ^ self.key) for char in self.source]
        checksum = sum(encrypted_bytes)
        payload = "{" + ",".join(map(str, encrypted_bytes)) + "}"
        
        # 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ VM –∫–æ–¥–∞ (–≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π)
        # –ú—ã —É–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤—Å—ë –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞–ø—É—Ç–∞–Ω–Ω–æ—Å—Ç–∏
        vm_logic = (
            f"local {self.v_data}={payload};"
            f"local {self.v_key}={self.key};"
            f"local {self.v_check}={checksum};"
            f"local {self.v_cur}=0;"
            f"for i=1,#{self.v_data} do {self.v_cur}={self.v_cur}+{self.v_data}[i] end;"
            f"if {self.v_cur}~={self.v_check} then while true do end end;"
            f"local {self.v_res}='';"
            f"for i=1,#{self.v_data} do "
            f"{self.v_res}={self.v_res}..string.char(bit32.bxor({self.v_data}[i],{self.v_key}));"
            f"if i%500==0 then task.wait() end "
            f"end;"
            f"local {self.v_func}=loadstring({self.v_res});"
            f"{self.v_res}=nil;"
            f"if {self.v_func} then task.spawn({self.v_func}) else warn('Critical Error') end"
        )
        
        # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã (–∫—Ä–æ–º–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö)
        one_liner = vm_logic.replace("  ", "").replace("\n", "")
        
        return header + one_liner

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –¢–ï–õ–ï–ì–†–ê–ú ---

@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer(
        "‚ú® **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Meloten Obfuscator!**\n\n"
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª `.lua` –∏–ª–∏ `.txt`, –∏ —è –ø—Ä–µ–≤—Ä–∞—â—É –µ–≥–æ –≤ –∑–∞—â–∏—â–µ–Ω–Ω—É—é –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—É—é VM.\n\n"
        "üì¢ –ö–∞–Ω–∞–ª: @Meloten_Obfuscator_bot",
        parse_mode="Markdown"
    )

@dp.message(F.document)
async def handle_file(message: types.Message):
    if not message.document.file_name.endswith(('.lua', '.txt')):
        await message.answer("‚ùå –û—à–∏–±–∫–∞! –ù—É–∂–µ–Ω —Ñ–∞–π–ª .lua –∏–ª–∏ .txt")
        return

    msg = await message.answer("üõ° –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ —É–ø–∞–∫–æ–≤–∫–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É...")
    
    try:
        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
        file_info = await bot.get_file(message.document.file_id)
        file_content = await bot.download_file(file_info.file_path)
        source = file_content.read().decode('utf-8', errors='ignore')

        # –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏
        obf = MelotenObfuscator(source)
        final_code = obf.build()

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        output = BufferedInputFile(
            final_code.encode('utf-8'), 
            filename=f"Meloten_{message.document.file_name}"
        )
        
        await message.answer_document(output, caption="‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞—â–∏—â–µ–Ω Meloten Obfuscator!")
        await msg.delete()
        
    except Exception as e:
        await message.answer(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

# --- –ó–ê–ü–£–°–ö ---
async def main():
    print("---------------------------------------")
    print("MELOTEN OBFUSCATOR IS ONLINE")
    print("---------------------------------------")
    await dp.start_polling(bot)

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
