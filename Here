import asyncio
import os
import logging
from aiogram import Bot, Dispatcher, F, types
from aiogram.types import FSInputFile
from aiogram.filters import Command
from aiogram.exceptions import TelegramBadRequest

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –¥–≤–∏–∂–æ–∫
from engine import DeobfuscatorEngine

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_TOKEN = ''  # <--- –í–°–¢–ê–í–¨ –¢–û–ö–ï–ù

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(name)s - %(message)s")
logger = logging.getLogger("DeobfBot")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–≤–∏–∂–∫–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()
engine = DeobfuscatorEngine()

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    await message.answer(
        "ü§ñ **Roblox Lua Deobfuscator**\n\n"
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª `.lua` –∏–ª–∏ `.txt`.\n"
        "–Ø –∑–∞–ø—É—â—É –µ–≥–æ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å—Ä–µ–¥–µ, –ø–µ—Ä–µ—Ö–≤–∞—á—É –±–∞–π—Ç–∫–æ–¥ –∏ –ø–æ–ø—Ä–æ–±—É—é –¥–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `unluac`.\n\n"
        "‚ö†Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: IronBrew, MoonSec, PSX Obfuscator –∏ –¥—Ä—É–≥–∏–µ VM.",
        parse_mode="Markdown"
    )

@dp.message(F.document)
async def handle_document(message: types.Message):
    user_id = message.from_user.id
    file_name = message.document.file_name
    
    # –ü—É—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    input_path = f"temp_in_{user_id}_{file_name}"
    output_path = f"Deobfuscated_{file_name}"

    status_msg = await message.answer("‚è≥ **–°–∫–∞—á–∏–≤–∞—é —Ñ–∞–π–ª...**", parse_mode="Markdown")
    
    # ### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ü–æ–ª—É—á–∞–µ–º loop –∑–¥–µ—Å—å, –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ ###
    loop = asyncio.get_running_loop()

    # –•–∞–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    last_status = [""]
    
    def sync_status_updater(text):
        if text == last_status[0]: return
        last_status[0] = text
        
        async def edit_coro():
            try:
                # –î–æ–±–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –±—ã–ª –ø—É—Å—Ç—ã–º
                if text:
                    await status_msg.edit_text(f"‚öôÔ∏è **–°—Ç–∞—Ç—É—Å:** {text}", parse_mode="Markdown")
            except TelegramBadRequest: 
                pass 
        
        # ### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é loop, –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—É—é –≤—ã—à–µ ###
        # –ú—ã –ù–ï –≤—ã–∑—ã–≤–∞–µ–º get_running_loop() –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ç–æ–∫–µ
        if not loop.is_closed():
            asyncio.run_coroutine_threadsafe(edit_coro(), loop)

    try:
        # 1. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await bot.get_file(message.document.file_id)
        await bot.download_file(file.file_path, input_path)

        with open(input_path, "rb") as f: content = f.read()

        # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        try:
            result_data = await asyncio.wait_for(
                asyncio.to_thread(engine.process, content, sync_status_updater),
                timeout=180.0
            )
        except asyncio.TimeoutError:
            result_data = b"-- [TIMEOUT] Process took too long ( > 3 mins)."
            await status_msg.edit_text("‚ùå **–û—à–∏–±–∫–∞:** –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç–µ–∫–ª–æ.")

        # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_path, "wb") as f: f.write(result_data)

        # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        out_file = FSInputFile(output_path)
        caption = "‚úÖ **–ì–æ—Ç–æ–≤–æ!**"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–π—Ç—ã, —Ç–∞–∫ –∫–∞–∫ result_data - —ç—Ç–æ bytes
        if b"Decompiled with unluac" in result_data:
            caption += "\nüìú –ë–∞–π—Ç–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫."
        elif b"WARNING: Decompilation failed" in result_data:
            caption += "\nüß© –ë–∞–π—Ç–∫–æ–¥ –ø–æ–π–º–∞–Ω, –Ω–æ –¥–µ–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä (Java) –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É."
        elif b"[FAIL]" in result_data:
            caption = "‚ùå **–ù–µ —É–¥–∞–ª–æ—Å—å:** –°–∫—Ä–∏–ø—Ç –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å (—Å–º. –ª–æ–≥–∏)."

        await message.answer_document(out_file, caption=caption)

    except Exception as e:
        logger.error(f"Global Error: {e}")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º try-except –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
        try:
            await status_msg.edit_text(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –±–æ—Ç–∞: {e}")
        except:
            await message.answer(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –±–æ—Ç–∞: {e}")
            
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        for p in [input_path, output_path]:
            if os.path.exists(p): 
                try: os.remove(p)
                except: passs
async def main():
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
