-- StarterGui/ScreenGui/LocalScript
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local mouse = player:GetMouse()
local spawnEvent = ReplicatedStorage:WaitForChild("SpawnEvent")
local spawnResponse = ReplicatedStorage:WaitForChild("SpawnResponse")

local gui = script.Parent
local spawnBtn = gui:WaitForChild("SpawnButton")
local energyLabel = gui:WaitForChild("EnergyLabel")
local hintLabel = gui:FindFirstChild("HintLabel")
local units = ReplicatedStorage:WaitForChild("Units")
local selectedUnit = (units:GetChildren()[1] and units:GetChildren()[1].Name) or nil

local placing = false
local preview = nil
local spawnPending = false
local TIMEOUT = 3

local function createPreview(template)
	if not template then return nil end
	local p = template:Clone()
	for _, d in ipairs(p:GetDescendants()) do
		if d:IsA("BasePart") then
			d.CanCollide = false
			d.Anchored = true
			d.Massless = true
			d.Transparency = (d.Transparency or 0) + 0.45
		elseif d:IsA("ParticleEmitter") or d:IsA("Trail") then
			pcall(function() d.Enabled = false end)
		elseif d:IsA("Script") then
			pcall(function() d.Disabled = true end)
		end
	end
	if not p.PrimaryPart then
		for _, d in ipairs(p:GetDescendants()) do
			if d:IsA("BasePart") then
				p.PrimaryPart = d
				break
			end
		end
	end
	p.Parent = workspace
	return p
end

local function updatePreviewPosition()
	if not preview or not preview.PrimaryPart then return end
	local rp = RaycastParams.new()
	rp.FilterDescendantsInstances = { player.Character, preview }
	rp.FilterType = Enum.RaycastFilterType.Blacklist
	local targetPos = nil
	if mouse.Target then
		targetPos = mouse.Hit.Position
	else
		local cam = workspace.CurrentCamera
		local mx, my = UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y
		local ray = cam:ScreenPointToRay(mx, my)
		local res = workspace:Raycast(ray.Origin, ray.Direction * 5000, rp)
		if res then targetPos = res.Position end
	end
	if not targetPos then return end
	local root
	for _, v in ipairs(preview:GetDescendants()) do
		if v:IsA("BasePart") then root = v; break end
	end
	local yOff = (root and root.Size.Y / 2) or 0
	local down = workspace:Raycast(targetPos + Vector3.new(0, 5, 0), Vector3.new(0, -30, 0), rp)
	local finalPos = (down and down.Position) or targetPos
	pcall(function() preview:SetPrimaryPartCFrame(CFrame.new(finalPos + Vector3.new(0, yOff, 0))) end)
end

local function startPlacement()
	if placing then return end
	placing = true
	local t = units:FindFirstChild(selectedUnit) or units:GetChildren()[1]
	preview = createPreview(t)
end

local function stopPlacement(destroyPreview)
	placing = false
	if destroyPreview and preview and preview.Parent then preview:Destroy() end
	preview = nil
end

local function tryPlaceAtMouse()
	if not preview then return end
	if spawnPending then
		if hintLabel then hintLabel.Text = "Spawn pending..." end
		delay(1.2, function() if hintLabel and hintLabel.Parent then hintLabel.Text = "" end end)
		return
	end
	local pos = preview.PrimaryPart and preview.PrimaryPart.Position or mouse.Hit.Position
	spawnPending = true
	spawnEvent:FireServer(selectedUnit, pos)
	delay(TIMEOUT, function()
		if spawnPending then
			spawnPending = false
			if hintLabel then
				hintLabel.Text = "Spawn timed out"
				delay(1.2, function() if hintLabel and hintLabel.Parent then hintLabel.Text = "" end end)
			end
		end
	end)
end

spawnBtn.MouseButton1Click:Connect(function()
	if not placing then startPlacement() else stopPlacement(true) end
end)

mouse.Button1Down:Connect(function()
	if placing then tryPlaceAtMouse() end
end)

spawnResponse.OnClientEvent:Connect(function(success, code)
	spawnPending = false
	if success then
		if hintLabel then hintLabel.Text = "Spawned" end
		stopPlacement(true)
	else
		if hintLabel then
			if code == "NotEnoughEnergy" then hintLabel.Text = "No energy"
			elseif code == "Duplicate" then hintLabel.Text = "Duplicate ignored"
			else hintLabel.Text = "Spawn failed: " .. tostring(code) end
			delay(1.2, function() if hintLabel and hintLabel.Parent then hintLabel.Text = "" end end)
		end
	end
end)

local function bindEnergyLabel()
	local p = player:WaitForChild("PrivateStats", 5)
	if not p then energyLabel.Text = "Energy: ?" return end
	local e = p:WaitForChild("Energy", 5)
	if not e then energyLabel.Text = "Energy: ?" return end
	energyLabel.Text = "Energy: " .. tostring(e.Value)
	e.Changed:Connect(function() energyLabel.Text = "Energy: " .. tostring(e.Value) end)
end

RunService.RenderStepped:Connect(function() if placing then updatePreviewPosition() end end)
bindEnergyLabel()
